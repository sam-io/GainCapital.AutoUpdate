<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<SourcePath>$(MSBuildProjectDirectory)\src\</SourcePath>
		<NuGetExe>$(MSBuildProjectDirectory)\src\.nuget\nuget.exe</NuGetExe>
		<MsBuildVersionOverridePath>$(MSBuildProjectDirectory)\tools\GainCapital.MsBuildVersionOverride\lib\net45\GainCapital.MsBuildVersionOverride.dll</MsBuildVersionOverridePath>
	</PropertyGroup>
	<Import Project="$(SolutionDir)\.nuget\NuGet.targets" Condition="Exists('$(SolutionDir)\.nuget\NuGet.targets')" />

	<UsingTask TaskName="VersionOverride" AssemblyFile="$(MsBuildVersionOverridePath)" />
	<UsingTask TaskName="VersionRestore" AssemblyFile="$(MsBuildVersionOverridePath)" />

	<PropertyGroup>
		<BUILD_VERSION>0.0.0</BUILD_VERSION>
		<VERSION_SUFFIX></VERSION_SUFFIX>
		<FullVersion>$(BUILD_VERSION.Replace('-', '.'))</FullVersion>
		<SemVersion>$(FullVersion)$(VERSION_SUFFIX)</SemVersion>
	</PropertyGroup>

	<ItemGroup>
		<AssemblyVersionFiles Include="$(MSBuildProjectDirectory)\**\AssemblyInfo.cs"/>
	</ItemGroup>

	<PropertyGroup>
		<Configuration>Release</Configuration>
		<Platform>Any CPU</Platform>
		<SolutionDir>src\</SolutionDir>
	</PropertyGroup>

	<Target Name="Build">
		<Exec Command='"$(NuGetExe)" restore' WorkingDirectory="$(SourcePath)" ContinueOnError='false'/>
		<VersionOverride CodePath="$(SourcePath)" NewVersion="$(FullVersion)" NewSemanticVersion="$(SemVersion)" BackupChangedFiles="true" />

		<MSBuild Projects="src/GainCapital.AutoUpdate.sln" Targets="Rebuild" Properties="Configuration=$(Configuration);Platform=$(Platform)" />

		<VersionRestore CodePath="$(SourcePath)"/>
	</Target>

	<Target Name="Package" DependsOnTargets="Build">
		<Message Text="Creating NuGet packages" />

		<Exec Command='"$(NuGetExe)" pack $(MSBuildProjectDirectory)\src\GainCapital.AutoUpdate\GainCapital.AutoUpdate.csproj -OutputDirectory "$(MSBuildProjectDirectory)\bin" -Version "$(SemVersion)" -IncludeReferencedProjects'
			ContinueOnError='false'/>

		<Exec Command='"$(NuGetExe)" pack $(MSBuildProjectDirectory)\src\DebugProject\DebugProject.csproj -OutputDirectory "$(MSBuildProjectDirectory)\bin" -Version "$(SemVersion)"'
			ContinueOnError='false'/>
	</Target>
</Project>
